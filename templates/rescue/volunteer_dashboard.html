<!-- templates/volunteer_dashboard.html -->
{% extends 'base/base.html' %}
{% load static %}
{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
{% csrf_token %}
<h2 style="text-align: center; margin-bottom: 30px;">Volunteer Dashboard</h2> <!-- Centered heading with margin -->
<div class="task-dashboard" style="display: flex; justify-content: space-between; margin-bottom: 40px;"> <!-- Added margin for spacing -->
    <div class="task-column">
        <h3>Available Tasks</h3>
        <ul>
            {% for task in available_tasks %}
                <li>
                    <strong>{{ task.title }}</strong>
                    <p>{{ task.description }}</p>
                    <form method="POST" action="{% url 'complete_task' task.id %}">
                        {% csrf_token %}
                        <button type="submit">Mark as Completed</button>
                    </form>
                </li>
            {% empty %}
                <li>No available tasks.</li>
            {% endfor %}
        </ul>
    </div>

    <div class="task-column">
        <h3>Completed Tasks</h3>
        <ul>
            {% for task in completed_tasks %}
                <li>
                    <strong>{{ task.title }}</strong>
                    <p>{{ task.description }}</p>
                </li>
            {% empty %}
                <li>No completed tasks.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<div id="map" style="height: 400px;"></div>  <!-- Ensure the map div has a height -->

<script>
let map, userMarkers = {};
const markerIcons = {
    'USER': L.icon({
        iconUrl: '/static/images/user-marker.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    }),
    'VOLUNTEER': L.icon({
        iconUrl: '/static/images/volunteer-marker.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    }),
    'ADMIN': L.icon({
        iconUrl: '/static/images/admin-marker.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    })
};

// Initialize the map
function initMap() {
    map = L.map('map').setView([27.531569, 80.748748], 10); // Default to a location
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Start fetching all user locations every 10 seconds
    setInterval(updateAllUsersLocations, 10000);
}

// Fetch and update all users & admin locations
async function updateAllUsersLocations() {
    try {
        const response = await fetch('/api/all-user-locations/');
        const data = await response.json();
        console.log("API Response Data:", data); // Debugging

        if (data.status === 'success') {
            data.users.forEach(user => {
                const markerId = `user-${user.id}`;
                const markerLatLng = [user.location.latitude, user.location.longitude];

                // Create or update marker
                if (userMarkers[markerId]) {
                    userMarkers[markerId].setLatLng(markerLatLng);
                    userMarkers[markerId].bindPopup(createPopupContent(user));
                } else {
                    const marker = L.marker(markerLatLng, { icon: markerIcons[user.user_type] || markerIcons['USER'] }).addTo(map);
                    marker.bindPopup(createPopupContent(user));
                    userMarkers[markerId] = marker;
                }
            });

            // Auto-adjust map to fit all markers
            const allMarkers = Object.values(userMarkers).map(marker => marker.getLatLng());
            if (allMarkers.length) {
                const bounds = L.latLngBounds(allMarkers);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
    } catch (error) {
        console.error('Error updating user locations:', error);
    }
}

// Watch volunteer's live location and update every 10 sec
function watchVolunteerLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
            async function (position) {
                if (!position.coords || !position.coords.latitude || !position.coords.longitude) {
                    console.error("Latitude or Longitude is missing!");
                    return;
                }

                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                console.log("Volunteer live location:", latitude, longitude);

                // Save in cookies
                document.cookie = `voln_latitude=${latitude}; path=/`;
                document.cookie = `voln_longitude=${longitude}; path=/`;

                // Update location in DB
                await updateVolunteerLocation(latitude, longitude);

                // Update marker on map
                if (userMarkers['current-volunteer']) {
                    userMarkers['current-volunteer'].setLatLng([latitude, longitude]);
                } else {
                    const volMarker = L.marker([latitude, longitude], { icon: markerIcons['VOLUNTEER'] }).addTo(map);
                    volMarker.bindPopup("YOU (Volunteer)");
                    userMarkers['current-volunteer'] = volMarker;
                }
            },
            function (error) {
                console.error('Error watching location:', error);
            },
            { enableHighAccuracy: true }
        );

        // Update location every 10 sec
        setInterval(async () => {
            const latitude = getCookie('voln_latitude');
            const longitude = getCookie('voln_longitude');

            if (latitude && longitude) {
                await updateVolunteerLocation(latitude, longitude);
            }
        }, 10000);
    } else {
        console.error('Geolocation is not supported by this browser.');
    }
}

// Send volunteer location to the backend
async function updateVolunteerLocation(latitude, longitude) {
    try {
        if (!latitude || !longitude) {
            console.error("Invalid volunteer coordinates:", latitude, longitude);
            return;
        }

        // Fetch CSRF Token
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfTokenElement ? csrfTokenElement.value : null;

        const headers = { 'Content-Type': 'application/json' };
        if (csrfToken) headers['X-CSRFToken'] = csrfToken;

        const response = await fetch('/api/save-location/', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ latitude, longitude })
        });

        if (!response.ok) {
            console.error("Failed to save volunteer location:", await response.text());
            return;
        }

        console.log("Volunteer location updated successfully.");
    } catch (error) {
        console.error('Error updating volunteer location:', error);
    }
}

// Helper function to create user popup content
function createPopupContent(user) {
    return `
        <div>
            <strong>Username:</strong> ${user.username}<br>
            <strong>Phone:</strong> ${user.phone}<br>
            <strong>Location:</strong> (${user.location.latitude}, ${user.location.longitude})<br>
            <strong>User Type:</strong> ${user.user_type}
        </div>
    `;
}

// Get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize map and watch location when page loads
document.addEventListener('DOMContentLoaded', function () {
    initMap();
    watchVolunteerLocation();
});

</script>
{% endblock %}